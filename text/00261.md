## Публикация в Интернете!

> **Примечание**: Эта глава может показаться сложной. Будьте упорны, развертывание сайта на сервере является важной частью веб-разработки. Данная глава намеренно расположена в середине учебника для того, чтобы ваш ментор смог помочь с таким мудреным процессом, как публикация сайта. Так вы сможете самостоятельно закончить все главы, даже если время будет поджимать.

До настоящего момента ваш сайт был доступен только для локального просмотра, теперь же вы узнаете, как развернуть его на удалённом сервере! Развертывание (deploy) — это процесс публикации приложения в интернете, чтобы люди могли наконец увидеть ваше творение :)

Как вы уже знаете, веб-сайт должен располагаться на сервере. Есть много компаний, предоставляющих сервера в интернете. Мы воспользуемся услугами одной из них, с довольно простым процессом публикации: [PythonAnywhere][1]. PythonAnywhere бесплатен для маленьких приложений с небольшим числом посетителей, и этого будет для нас более чем достаточно.

 [1]: https://www.pythonanywhere.com/

Другим внешним сервисом, которым мы воспользуемся, будет [GitHub][2] — сервис хостинга кода. Существуют и другие похожие сервисы, но практически у каждого программиста есть GitHub аккаунт, теперь будет и у вас!

 [2]: https://www.github.com

В итоге ваш код будет в трёх местах. На локальном компьютере вы будете заниматься разработкой и тестированием. Когда результат вас устроит, вы загрузите свою программу на GitHub. А ваш сайт будет на PythonAnywhere, и вы сможете обновлять его, просто загружая новую версию кода с GitHub.

## Git

> **Примечание:** если вы уже выполнили установку, незачем повторять её вновь — можете сразу переходить к следующему разделу и начать создание собственного Git-репозитория.

Git — это «система управления версиями», используемая множеством программистов. Эта программа отслеживает изменения, происходящие с файлами, чтобы впоследствии можно было восстановить состояние кода на нужный момент времени. Это немного похоже на функцию отслеживания изменений в Microsoft Word, но куда мощнее.

### Установка Git

#### Windows

Вы можете загрузить Git с официального сайта [git-scm.com](https://git-scm.com/). Вы можете нажимать "дальше, дальше, дальше" на всех этапах установки за исключением одного: на пятом шаге, который называется "Adjusting your PATH environment" (Настройка системной переменной Path), выберите "Use Git and optional Unix tools from the Windows Command Prompt" (Запуск Git и соответствующих Unix утилит через командную строку Windows, нижняя опция). Все остальные настройки можно оставить по умолчанию. Также неплохо будет выбрать опцию "Checkout Windows-style, commit Unix-style line endings".

После окончания установки не забудьте перезапустить командную строку или powershell.

#### OS X

Загрузите Git с официального сайта [git-scm.com](https://git-scm.com/) и просто следуйте инструкциям по установке.

> **Примечание:** если вы используете OS X 10.6, 10.7 или 10.8, вам придётся установить git отсюда: [Установка Git для OS X Snow Leopard](https://sourceforge.net/projects/git-osx-installer/files/git-2.3.5-intel-universal-snow-leopard.dmg/download)

#### Debian и Ubuntu

```bash
$ sudo apt install git
```

#### Fedora

```bash
$ sudo dnf install git
```

#### openSUSE

```bash
$ sudo zypper install git
```

### Создаём Git-репозиторий

Git отслеживает изменения определенного набора файлов, который называется репозиторием (сокращенно "репо"). Давайте создадим такой для нашего проекта. Откройте консоль и запусти эти команды в папке `vectree`:

> **Примечание:** проверьте текущий рабочий каталог с помощью команд `pwd` (OSX/Linux) или `cd` (Windows) перед инициализацией нового репозитория. ВЫ должны находиться в директории `vectree`.

```bash
$ git init
Initialized empty Git repository in ~/vectree/.git/
$ git config --global user.name "Your Name"
$ git config --global user.email you@example.com
```

Инициализировать git-репозиторий придется только один раз за проект (и вам больше не придется вводить имя пользователя и адрес электронной почты).

Git будет отслеживать изменения всех файлов и каталогов в заданной директории, однако некоторые из них мы предпочли бы игнорировать. Для этого нам нужно создать файл `.gitignore` в корневом каталоге репозитория. Откройте редактор и создайте новый файл со следующим содержанием:

```gitignore
*.pyc
*~
__pycache__
myvenv
db.sqlite3
/static
.DS_Store
```

И сохраните его как `.gitignore` в корневом каталоге "vectree".

> **Примечание:** точка в начале имени файла имеет важное значение! Если у вас есть проблемы с созданием таких файлов (Mac не позволит создать файл с названием, начинающимся с точки, через Finder, например), тогда используйте кнопку «Сохранить как» в меню своего редактора кода, это точно поможет.

> **Примечание:** среди файлов, которые мы перечислили в `.gitignore`, есть `db.sqlite3`. Этот файл содержит вашу локальную базу данных, где будут храниться ваши посты. Мы не добавляем его в репозиторий, поскольку ваш сайт на PythonAnywhere будет использовать другую базу данных. Эта база данных тоже может быть SQLite, как на вашем рабочем компьютере, но обычно используется MySQL, которая может справиться с большим количеством посетителей, чем SQLite. В любом случае, поскольку мы не копируем базу данных SQLite на GitHub, все посты, которые вы уже создали, будут доступны только на вашем локальном компьютере, и вам придётся заново создать их на опубликованном сайте. Рассматривайте свою локальную базу данных как удобную игровую площадку, где вы можете тестировать различные идеи и не бояться удалить настоящий пост из своего блога.

Используйте команду `git status` перед `git add` или в любой другой момент, когда вы не уверены, что изменения — хорошая идея. Это убережёт вас от таких неприятных сюрпризов, как добавление неправильных файлов. Команда `git status` возвращает информацию обо всех ранее неотслеживаемых/изменённых/добавленных в git файлах, а также статус ветки и многое другое. Результат должен быть похож на:

```bash
$ git status
On branch master

Initial commit

Untracked files:
  (use "git add <file>..." to include in what will be committed)

        .gitignore
        blog/
        manage.py
        mysite/

nothing added to commit but untracked files present (use "git add" to track)
```

И, наконец, мы сохраним наши изменения. Переключитесь на консоль и наберите:

```bash
$ git add --all .
$ git commit -m "My Vectree app, first commit"
 [...]
 13 files changed, 200 insertions(+)
 create mode 100644 .gitignore
 [...]
 create mode 100644 mysite/wsgi.py
 ```

### Загружаем код в репозиторий GitHub

Зайдите на [GitHub.com][2] и создайте новую бесплатную учётную запись. Убедитесь, что запомнили свой пароль (добавьте его в свой менеджер паролей, если им пользуетесь).

Затем создайте новый репозиторий и назовите его "my-first-blog". Не выбирайте опцию "initialise with a README", не создавайте файл .gitignore (мы сделаем это локально сами) и оставьте лицензию None.

![][3]

 [3]: https://user-images.githubusercontent.com/4215285/72188728-12ed1280-340c-11ea-9b91-63bfbfff1804.png

> **Примечание:** имя репозитория `my-first-blog` для нас очень важно — вы можете, конечно, придумать другое название, но оно будет встречаться множество раз в руководстве, и вам придется заменять его каждый раз на своё. Будет проще для начала остановиться на нашем варианте: `my-first-blog`.

На следующем экране вы найдёте URL для клонирования репозитория. Выберите вариант "HTTPS" и скопируйте ссылку:

![][4]

 [4]: https://user-images.githubusercontent.com/4215285/72188762-2e581d80-340c-11ea-857a-2930bdf4c44a.png

Теперь нужно связать локальный репозиторий с репозиторием на GitHub.

Напечатайте у себя в консоли следующую команду (замените `<your-github-username>` на имя, указанное при создании аккаунта на GitHub, но без угловых скобок):

```bash
$ git remote add origin https://github.com/<your-github-username>/my-first-blog.git
$ git push -u origin master
```

Введите свое имя пользователя и пароль от аккаунта GitHub; вы должны увидеть что-то такое:

```
Username for 'https://github.com': hjwp
Password for 'https://hjwp@github.com':
Counting objects: 6, done.
Writing objects: 100% (6/6), 200 bytes | 0 bytes/s, done.
Total 3 (delta 0), reused 0 (delta 0)
To https://github.com/hjwp/my-first-blog.git
 * [new branch]      master -> master
Branch master set up to track remote branch master from origin.
```

<!--TODO: maybe do ssh keys installs in install party, and point ppl who dont have it to an extension -->

Ваш код теперь на GitHub. Зайдите на сайт и проверьте! Вы найдете его в хорошей компании: [фреймворк Django][5], [этот учебник][6], а также многие другие великолепные проекты с исходным кодом размещены на GitHub :)


 [5]: https://github.com/django/django
 [6]: https://github.com/vectree/resources

## Настройка блога на PythonAnywhere

### Регистрация на PythonAnywhere

> **Примечание:** возможно, вы уже завели учётную запись на PythonAnywhere ранее — если так, нет нужды повторять это вновь.

PythonAnywhere — это сервис по запуску кода на Python в облаке. Мы будем использовать его, чтобы разместить наш сайт «вживую» в интернете.

Создайте аккаунт уровня "Beginner" на PythonAnywhere. Он бесплатный, так что кредитка не понадобится.

  * [www.pythonanywhere.com](https://www.pythonanywhere.com/)

  ![Страница регистрации на PythonAnywhere с кнопкой создания бесплатного 'Beginner' аккаунта](https://user-images.githubusercontent.com/4215285/72188878-72e3b900-340c-11ea-925e-5e94ec5abfdc.png)

> **Примечание:** при выборе имени пользователя помните, что URL блога примет вид `yourusername.pythonanywhere.com`, так что остановитесь либо на своём нике, либо на имени, связанном с тематикой блога. Кроме того, убедитесь в том, что запомнили пароль (сохраните его в своём менеджере паролей, если им пользуетесь).

### Создание API токена для PythonAnywhere

Это нужно будет сделать только один раз. Когда вы зарегистрируетесь на PythonAnywhere, откроется панель управления (dashboard). На ней в правом верхнем углу будет ссылка на страницу «Account»:

![Account link on the top right on the page](https://user-images.githubusercontent.com/4215285/72188886-75dea980-340c-11ea-9212-a92df6cd54fb.png)

Там выберите вкладку «API token» и нажмите кнопку, на которой написано «Create new API token» (создать новый API token).

![The API token tab on the Account page](https://user-images.githubusercontent.com/4215285/72188893-78d99a00-340c-11ea-808b-bfc35b2f00a1.png)

### Настройка сайта на PythonAnywhere

Вернитесь на [главную страницу PythonAnywhere](https://www.pythonanywhere.com/), кликнув логотип. Затем запустите Bash-консоль. Нажав на кнопку bash вы запускаете командную строку, которая находится на серверах PythonAnywhere. Эта командная строка аналогична тому, что есть на вашем собственном компьютере.

<img src="https://user-images.githubusercontent.com/4215285/72188978-b76f5480-340c-11ea-86a7-2ed6ef83f8c4.png" alt="Раздел «New Console» (новая консоль) в веб-интерфейсе PythonAnywhere с кнопкой «bash»" />

> **Примечание:** PythonAnywhere использует Linux, так что если вы используете Windows, то терминал и команды могут немного отличаться от того, к чему вы привыкли на своём компьютере.

Чтобы опубликовать сайт на PythonAnywhere, нужно загрузить на PythonAnywhere ваш код с Github и затем настроить PythonAnywhere так, чтобы он распознал ваш код и запустил ваше веб-приложение. Существуют способы сделать это «вручную», но для PythonAnywhere есть программа-помощник, которая сделает это для вас. Давайте её установим.

```bash
$ pip3.6 install --user pythonanywhere
```

Когда вы это запустите, в консоли будет печататься лог установки. Он начнётся с чего-то вроде `Collecting pythonanywhere`, а последней будет строчка `Successfully installed (...) pythonanywhere- (...)`.

Теперь запустим эту вспомогательную утилиту, которую вы только что установили. Она настроит ваше приложение, скачав его код с GitHub. Напечатайте следующее в консоли PythonAnywhere (не забудьте использовать свой ник на GitHub вместо `<your-github-username>`, URL в консольной команде должен совпадать с URL, используемый в команде clone):

```bash
$ pa_autoconfigure_django.py https://github.com/<your-github-username>/my-first-blog.git
```

Утилита будет печатать в консоль, что она делает:

- Скачивает ваш код с GitHub
- Создаёт виртуальное окружение на PythonAnywhere, такое же, как на вашем компьютере
- Обновляет ваш файл настроек с настройками деплоя
- Создаёт базу данных на PythonAnywhere, используя команду `manage.py migrate`
- Разбирается с вашим статическими файлами (о них будет дальше)
- Настраивает PythonAnywhere так, чтобы ваше приложение было доступно в интернете

Все эти шаги автоматизированы на PythonAnywhere, но они совершенно такие же, какие надо было бы совершить с любым другим хостинговым сервисом.

Главное, на что нужно обратить внимание сейчас, — это то, что ваша база данных на PythonAnywhere никак не связана с базой данных на вашем компьютере. Поэтому там будут разные посты и разные аккаунты администраторов. Как следствие, для базы на PythonAnywhere необходимо создать аккаунт администратора так же, как вы это делали у себя локально с помощью команды `createsuperuser`. На PythonAnywhere заранее активировано виртуальное окружение, так что всё, что вам нужно сделать — это запустить в консоли PythonAnhywhere команду:

```bash
(ola.pythonanywhere.com) $ python manage.py createsuperuser
```

Введите параметры для своего пользователя-админа. Лучше всего использовать те же самые данные, что и у вас на локальном компьютере, чтобы избежать путаницы, если вы конечно не хотите сделать пароль на сервере PythonAnywhere более надёжным.

Сейчас, если хотите, посмотри на файлы на PythonAnywhere с помощью команды `ls`:

```bash
(ola.pythonanywhere.com) $ ls
blog  db.sqlite3  manage.py  mysite requirements.txt static
(ola.pythonanywhere.com) $ ls blog/
__init__.py  __pycache__  admin.py  apps.py  migrations  models.py
tests.py  views.py
```

Вы также можете заглянуть на страницу «Files» и посмотреть, что лежит на сервере, используя встроенный в PythonAnywhere файловый менеджер. (Со страницы «Console» вы можете попасть на другие страницы PythonAnywhere используя кнопку меню в правом верхнем углу. Находясь на какой-либо странице, вы можете найти ссылки на другие вверху.)

## Вы в сети!

Ура, ваш сайт теперь доступен всем в интернете! Вы можете найти ссылку на него на странице «Web» на PythonAnywhere. Этой ссылкой можно делится с кем хотите :)

> **Примечание** Это туториал для начинающих, поэтому публикуя сайт, мы использовали несколько хаков, которые не очень хороши с точки зрения безопасности. Если вы захотите сделать что-то на основе этого проекта или начать новый, прочитайте [Django deployment checklist](https://docs.djangoproject.com/en/2.0/howto/deployment/checklist/) для советов по безопасности на вашем сайте.

### Советы по отладке

Если вы столкнулись с ошибкой, запуская скрипт `pa_autoconfigure_django.py`, вот несколько частых причин:

- Забыли создать PythonAnywhere API токен
- Ошибка в GitHub URL
- Если вы видите сообщение *"Could not find your settings.py"* (невозможно найти settings.py), это может быть вызвано тем, что вы не добавили все файлы в Git или не загрузили их на GitHub. Перечитайте Git-секцию выше.

Если вы столкнулись с ошибкой при попытке открыть свой сайт, первое место, где нужно искать отладочную информацию — ваш **error log**. Вы найдёте ссылку на него на странице ["Web"](https://www.pythonanywhere.com/web_app_setup/) на PythonAnywhere. Гляньте, есть ли там какие-либо сообщения об ошибках; самые новые находятся внизу.

Ещё есть [общие советы по отладке на PythonAnywhere](http://help.pythonanywhere.com/pages/DebuggingImportError).

И помните, ваш ментор здесь, чтобы помочь!

## Вы в сети!

Стандартная страница вашего сайта должна включать приветствие "It worked!", точно так же как было на локальном компьютере. Попробуйте добавить `/admin/` к концу адреса сайта, и перейдете к панели администратора сайта. Войдите под своим именем и паролем и увидите форму для добавления новых записей в блог.

После того, как создадите несколько записей, вы можете вернуться к своей локальной версии приложения (а не на PythonAnywhere). С этого момента для внесения изменений вам нужно работать в своей локальной версии. Это обычный подход в веб-программировании: изменять код локально, загружать изменения на GitHub, а затем подтягивать изменения на сервер с сайтом. Такой подход позволяет вам работать и экспериментировать, не рискуя сломать свой сайт. Круто, правда?

Вы заслужили *огромную* похвалу! Развёртывание сервера — одна из самых каверзных частей веб-разработки, и нередко уходит несколько дней, прежде чем заставишь всё работать. А у нас уже есть работающий в сети веб-сайт, вот так вот!

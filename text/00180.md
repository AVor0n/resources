## Express 101

В последнем уроке мы подготовили для вас почву, объяснив базовые вещи, которые понадобятся для понимания происходящего. Следуя инструкциям [учебника от MDN](https://developer.mozilla.org/ru/docs/Learn/Server-side/Express_Nodejs/skeleton_website), вы потихоньку начнете работать с проектом.

### По окончанию

К концу этого урока вы сможете:

 - Использовать `express-generator` для генерации базового express-сайта;
 - Изучить основные части express-проекта;
 - Понять, что такое язык шаблонов, и перечислить пару популярных;
 - Понять, что такое middleware;
 - Понять, что такое `req`,` res` и `next` в контексте функции промежуточной обработки (middleware).

### Шаблонные движки

Шаблонный движок - это инструмент, который позволяет вам вставлять переменные и простую логику в представление. Например, у вас может быть заголовок, который обновляется (в нем появляется имя) после того, как пользователь вошел в систему. Сделать такое невозможно, используя только HTML. Как мы уже упоминали, для JavaScript доступно несколько языков шаблонов. В [учебнике от MDN](https://developer.mozilla.org/ru/docs/Learn/Server-side/Express_Nodejs/skeleton_website) используется `Pug` (ранее известный как `Jade`), который имеет некоторую сложность в изучении, поскольку значительно отличается от обычного HTML. Если вы когда-либо работали с Ruby on Rails, вам может быть удобно использовать `ejs`, который выглядит как HTML, _очень_ похож на `erb` и `hbs` (handlebars) и вставляет динамический код внутрь двойных фигурных скобок.

Что вы выбираете - зависит от вас! Если вы решите не использовать `Pug`, вы все равно сможете следовать учебнику MDN. Большинство участников Vectree предпочитают `ejs` перед `Pug` просто потому, что им нравится работать с HTML. В любом случае, в использовании Pug нет ничего плохого, если вам нравится его внешний вид или вы хотите узнать что-то новенькое.

### Middleware

На этом этапе учебника по MDN упоминаются [функции промежуточной обработки](https://expressjs.com/ru/guide/using-middleware.html) - middleware, которые не имеют четкого определения. Middleware - сложное слово простой концепции. Middleware - обычная функция JavaScript, которую Express будет вызывать между моментом получения сетевого запроса и моментом отправки ответа (т.e. эта функция находится в _середине_ - _middle_). В конечном итоге для каждого запроса вы будете использовать несколько функций, которые будут выполняться в определенной последовательности.

Например, такими middleware может быть логгер (который выводить детали запроса в консоль), аутентификатор (который проверяет, вошел ли пользователь в систему или имеет разрешение на доступ) и статический файл-сервер (отправляем запрашиваемый статический файл). Все эти функции будут вызываться в указанном вами порядке каждый раз, когда есть запрос связанный с вашей функцией `app.get('/')`.

Можно и нужно писать свои собственные middleware-функции (мы сделаем это позже), поэтому давайте уделим минуту для расскрытия того, что они делают. Middleware-функции - это функции JavaScript с определенной сигнатурой (они принимают определенный набор аргументов в определенном порядке). Вы это уже видели!

Три аргумента middleware-функции: `req`, `res` и `next`. Технически, это просто переменные, так что вы можете присваивать им любые имена, но есть соглашения, по которым советуется всегда именовать их так. Например вся документация express соблюдает эти соглашения.

#### Middleware-функция

~~~javascript
function(req, res, next) {
  // ваш код!
}
~~~

Когда кто-то посещает ваш сайт, его браузер отправляет запрос на ваш сервер. Express принимает этот запрос и пробрасывает его через все middleware-функции, которые вы определили в своем проекте. В каждую функцию передаются параметры `req` и `res`, которые могут показаться вам знакомыми из предыдущего урока по Node. `req` и `res` _практически_ такие же, как и в ванильной Node, но Express расширяет их, добавляя несколько полезных свойств и методов.

`req` или `request` - это объект, который содержит данные о входящем запросе, точный URL-адрес посещения, параметры в URL-адресе, тело (`body`) запроса (полезно, если пользователь отправляет форму с данными) и многое другое.

 - Вы можете увидеть все, что включает `request` в [документации](https://expressjs.com/en/4x/api.html#req).

 `res` или `response` - это объект, отвечающий за ответ, который Express отправит обратно пользователю. Как правило, вы используете информацию в `req` и определяете, что делать с запросом и в конце вызываете `res.send()` или другой метод объекта `res`.

 - Документация ``res`` [здесь](https://expressjs.com/en/4x/api.html#res)!

`next` - это функция, которую вы видели немного реже, но она **очень** важна для правильного функционирования вашего приложения. Если вы пишете или используете какой-то middleware, который не отправляет ответ клиенту, тогда вы должны _вызвать_ функцию `next` в конце вашей функции промежуточной обработки. Функция `next` говорит Express перейти к следующему middleware в стеке. Если вы забудете вызвать `next`, то ваше приложение остановится и ничего не произойдет!

#### Пример middleware

В качестве быстрого примера, если вы хотите создать простое промежуточное программное обеспечение для ведения журналов, вы можете написать такую ​​функцию:

~~~javascript
const myLogger = function(req, res, next) {
  console.log("Request IP: " + req.ip);
  console.log("Request Method: " + req.method);
  console.log("Request date: " + new Date());
  
  next(); // ЭТО ВАЖНО!
}
~~~

`app.use` - это способ загрузки вашего middleware в Express. Если вы вставите этот фрагмент кода (пример выше) где-то в начало файла `app.js` (после части, в которой вы определяете `app = express()`), то каждый раз при запросе будут выводится детали этого запроса в вашу консоль. Когда вывод информации (логирование) завершен, мы вызываем функцию `next()`, чтобы наше приложение могло продолжить работу.

И наконец, важен порядок выполнения middleware в вашем приложении! Middleware всегда будут выполняться в том порядке, в котором они были переданы в `app.use()`.

### Использование git

Если в завершении урока вы используете git (вы должны!), то логично добавить файл `.gitignore`. Это позволит вам не коммитить / загружать папку `node_modules` в GitHub. `node_modules` - это каталог, в котором хранятся все зависимости вашего проекта (тут хранится код для express), и он может стать довольно большим. Ссылки на все эти зависимости в любом случае есть в файле `package.json`, поэтому любой, кто хочет клонировать и работать над проектом, просто запускает `npm install`, чтобы загрузить и установить все эти зависимости. Поэтому загрузка `node_modules` в GitHub - пустая трата времени и пространства.

- [Эта статья](https://www.atlassian.com/git/tutorials/saving-changes/gitignore) или [эта на русском](https://uleming.github.io/gitbook/4_%D0%98%D0%B3%D0%BD%D0%BE%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%84%D0%B0%D0%B9%D0%BB%D0%BE%D0%B2.html) объясняет процесс. Вам просто нужно создать файл с именем `.gitignore` и поместить строку `node_modules` в этот файл.

### Задание

1. Прочтите [вступительную статью](https://developer.mozilla.org/ru/docs/Learn/Server-side/Express_Nodejs/%D0%A3%D1%87%D0%B5%D0%B1%D0%BD%D0%B8%D0%BA_%D1%81%D0%B0%D0%B9%D1%82_local_library) на MDN;
2. Начните проект, следуя [этому уроку](https://developer.mozilla.org/ru/docs/Learn/Server-side/Express_Nodejs/skeleton_website). Прочитайте все внимательно! В этой статье довольно много важной информации;
3. Для получения более подробной информации о природе middleware прочитайте официальную документацию [здесь](https://expressjs.com/ru/guide/using-middleware.html).

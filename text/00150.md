## Работы с API

### Введение

Одна из самых важнейших вещей, которую может сделать веб-разработчик, - это загрузка данных с сервера и визуальное отображение на сайте. 
Часто сервер используется только одним конкретным сайтом и может хранить сообщения блога, пользовательские данные, статистику игрока или что-то еще. 
В других случаях сервер является [открытым сервисом](https://ru.wikipedia.org/wiki/%D0%92%D0%B5%D0%B1-%D1%81%D0%BB%D1%83%D0%B6%D0%B1%D0%B0), которая предоставляет данные любому, кто хочет его использовать (например, данные о погоде или цены на акции). В любом случае методы доступа и последующего использования этих данных, по сути, одинаковы.

### API

Серверы, созданные для обслуживания данных, используемых внешними источниками (веб-сайтами или приложениями), называют `API` или [Программный интерфейс приложения](https://www.youtube.com/watch?v=ILKh5-7QKBw).

Существует несколько способов запроса данных с API, но все они в основном похожи. 
Чаже всего доступ к API осуществляется через URL-адреса. 
А формат самого запроса изменяется в зависимости от сервиса, который вы используете. 
Например, API OpenWeatherMap имеет несколько типов данных, которые вы можете запросить. 
Чтобы узнать текущую погоду в определенном месте, вам нужно запросить данные с помощью такого URL:

~~~
api.openweathermap.org/data/2.5/weather?q=London,uk
~~~

Вы наверняка захотите поменять город на свой. Дерзайте! 
Особенности использования API обычно документируются на веб-сайте сервиса. [Изучите документацию OpenWeatherMap API](https://openweathermap.org/current).

Вставьте приведенный выше URL-адрес погоды в свой браузер, если вы этого еще не делали... а мы подождем.

Если API не изменился со временем, вы получите ошибку, подобную этой:

~~~
{"code":401, "message": "Invalid API key. Please see http://openweathermap.org/faq#error401 for more info."}
~~~

Это подводит нас к другому вопросу о API. В большинстве случаев вам необходимо зарегистрироваться и получить ключ для использования API. 
Получить ключ API так же просто, как зарегистрироваться на веб-сайте, а использовать его так же просто (правда это зависит от сервиса), как вставить параметр в URL:

~~~
http://api.openweathermap.org/data/2.5/weather?q=London,uk&APPID=1111111111
~~~

OpenWeatherMap использует ключ API для отслеживания того, кто запрашивает данные и объем данных, которые запрашивается пользователем. 
Они делают это для того, чтобы все одинаково и равномерно могли пользоваться их услугами. 
Запуск серверов, особенно крупных, стоит денег, и хотя каждый запрос погоды (или любой другой) является относительно дешевым, если количество запросов станет слишком высоким, стоимость может быть огромной. 
Представьте, что вы используете это API для создания крутого погодного приложения, которое популярно во всем мире... тысячи людей могут обращаться за этими данными! Каждую минуту!

Регистрируясь на сервисе и получая ключ API, вы позволяете сервису отслеживать, сколько вы фактически используете мощностей. 
Обычно есть ограничения на бесплатное использование. Если у вас приложение погоды, то вы можете делать только 60 запросов в минуту и только к ограниченному множеству данных ([подробности здесь, если интересно](https://openweathermap.org/price)). 
Итак, если ваше приложение стало успешным, вам придется заплатить за лучшие условия.

К счастью для нас, большинство ваших приложений будут использоваться только вами и людьми, которые просматривают ваши портфолио. 
Поэтому нас _не страшат_ ограничения бесплатного пользования.

Как только вы получите ключ (создайте его сейчас, если хотите!), вы можете снова вставить URL в браузер (не забудьте добавить ключ) и увидеть правильный ответ:

~~~JSON
{"coord":{"lon":-77.73,"lat":38.77},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"base":"stations","main":{"temp":75.74,"pressure":1017,"humidity":57,"temp_min":71.6,"temp_max":78.8},"visibility":16093,"wind":{"speed":3.87,"deg":291},"clouds":{"all":1},"dt":1504188900,"sys":{"type":1,"id":2886,"message":0.0053,"country":"US","sunrise":1504175992,"sunset":1504222878},"id":4775660,"name":"New Baltimore","cod":200}
~~~

### Загрузка данных

Так как же мы на самом деле получаем данные из API в коде?

Пару лет назад основным способом доступа к данным API в коде было использование `XMLHttpRequest`. Эта функция по-прежнему работает во всех браузерах, но, к сожалению, ее использование - боль. Синтаксис выглядит примерно так:

~~~javascript
// XHR - беспорядок!
if (window.XMLHttpRequest) { // Mozilla, Safari, ...
  request = new XMLHttpRequest();
} else if (window.ActiveXObject) { // IE
  try {
    request = new ActiveXObject('Msxml2.XMLHTTP');
  }
  catch (e) {
    try {
      request = new ActiveXObject('Microsoft.XMLHTTP');
    }
    catch (e) {}
  }
}

// Открываем, отправляем.
request.open('GET', 'https://url.com/some/url', true);
request.send(null);
~~~


Ау. Было больно.

Разработчики от безысходности начали писать сторонние библиотеки, чтобы сделать жизнь намного проще. 
Вот некоторые из наиболее популярных библиотек: [request](https://github.com/request/request), [axios](https://github.com/mzabriskie/axios) и [superagent](https://github.com/visionmedia/superagent). 
Каждая библиотека имеет свои сильные и слабые стороны.

Однако в последнее время браузеры начали внедрять новую встроенную функцию для выполнения HTTP-запросов, и мы будем использовать ее. Познакомьтесь с `fetch`:

~~~javascript
// URL (обязателен), options (не обязателен)
fetch('https://url.com/some/url')
  .then(function(response) { })
  .catch(function(err) {
    // Ошибка :(
  });
~~~

Если забыли, гляньте еще раз на XHR. Пока вы восхищаетесь тем, насколько красив и чист этот код, обратите внимание на функции `.then()` и `.catch()`. Помните что это? Промисы!

Давайте поменяем наш API на новый. Воспользуемся `fetch` для работы с API [giphy](https://giphy.com/), который предоставляет случайный GIF-файл. 
API требует, чтобы вы зарегистрировались и получили бесплатный ключ, поэтому [займитесь этим тут](https://developers.giphy.com/docs/).

У Giphy есть несколько методов поиска картинок, о которых вы можете узнать из их документации. 
Сейчас мы воспользуемся простейшим endpoint'ом `translate`. Вы можете найти соответствующий URL в документации, прокрутив [вниз](https://developers.giphy.com/docs/). 
Где нас скажут, что правильный URL-адрес - это `api.giphy.com/v1/gifs/translate`. Для него требуется 2 параметра: ваш `api_key` (ключ) и `s`earch term (ключевое слово). 
Если вы сделали все правильно (воспользовались СВОИМ API-ключом), вы должны получить что-то вроде этого:

~~~javascript
'https://api.giphy.com/v1/gifs/translate?api_key=ВАШ_КЛЮЧ&s=cats'
// Конечно, мы ищем котиков!
~~~

Проверьте этот URL (не забудьте использовать СВОЙ ключ API) в браузере. Если вы сделали все верно, то получите относительно длинную строку данных и отсутствие ошибок.

### CORS

Маленькое примечание, прежде чем мы начнем писать код. 
По соображениям безопасности по умолчанию браузеры ограничивают запросы HTTP к внешними источниками (что мы тут и делаем). 
Существует небольшое количество настроек, которые нам нужно сделать, чтобы все работало правильно. 
Изучение этого вопроса выходит за рамки нашей компетенции на текущий момент, но если вы хотите немного узнать об этом, то изучите [статью на Википедии](https://ru.wikipedia.org/wiki/Cross-origin_resource_sharing).

Независимо от того читали вы или нет о Cross Origin Resource Sharing (CORS), убрать ограничения достаточно просто. 
Используя `fetch`, вы можете легко передать в него объект с настройками. Объект передается вторым параметром сразу после URL:

~~~javascript
fetch('url.url.com/api', {
  mode: 'cors'
});
~~~

Простое добавление `{mode: 'cors'}` после URL временно решает наши проблемы. 
Однако в будущем советуем вам подробнее изучить последствия этого ограничения.

### Сделаем это

Сейчас мы объединим все в одном HTML-файле. Добавьте в `body` изображение (`img`) и тег скрипта (`script`).

~~~HTML
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
</head>
<body>
  <img src="#" />
  <script>
  </script>
</body>
</html>
~~~

В теге script начнем с выбора элемента изображения и присвоения его переменной. В итоге мы сможем изменить URL-адрес элемента после того, как получим изображение от Giphy API.

~~~HTML
<script>
  const img = document.querySelector('img');
</script>
~~~

Добавим fetch:

~~~HTML
<script>
  const img = document.querySelector('img');
  fetch('https://api.giphy.com/v1/gifs/translate?api_key=ВАШ_КЛЮЧ&s=cats', {mode: 'cors'})
    .then(function(response) {
      console.log(response.json());
    });
</script>
~~~

Теперь вы сможете открыть HTML-файл в своем браузере. 
Хотя вы ничего и не увидите на самой странице, _зайдите_ в консоль и посмотрите ответ. 
Самая интересная часть этого процесса - преобразование данных, полученных от сервера в нужный формат. 
В данном случае выведем то, что возвращается _другой_ promise... для получения данных в нужном формате нам нужна еще одна функция `.then()`.

~~~HTML
<script>
  const img = document.querySelector('img');
  fetch('https://api.giphy.com/v1/gifs/translate?api_key=ВАШ_КЛЮЧ&s=cats', {mode: 'cors'})
    .then(function(response) {
      return response.json();
    })
    .then(function(response) {
      console.log(response);
    });
</script>
~~~

Теперь вы получили объект JavaScript. Если вы достаточно внимательно изучите его, вы обнаружите, что данные, которые нам нужны (URL-адрес изображения), достаточно глубоко вложены в объект:

![response](https://raw.githubusercontent.com/TheOdinProject/javascript_curriculum/master/async-apis/images/apiresponse.png)

Чтобы добраться до данных, нам нужно пройти через слои объекта, пока мы не найдем то, что хотим!

~~~HTML
<script>
  const img = document.querySelector('img');
  fetch('https://api.giphy.com/v1/gifs/translate?api_key=ВАШ_КЛЮЧ&s=cats', {mode: 'cors'})
    .then(function(response) {
      return response.json();
    })
    .then(function(response) {
      console.log(response.data.images.original.url);
    });
</script>
~~~

Консоль теперь должна выводить URL-адрес изображения. Все, что осталось сделать, это задать источник (`src`) изображения:

~~~HTML
<script>
  const img = document.querySelector('img');
  fetch('https://api.giphy.com/v1/gifs/translate?api_key=ВАШ_КЛЮЧ&s=cats', {mode: 'cors'})
    .then(function(response) {
      return response.json();
    })
    .then(function(response) {
      img.src = response.data.images.original.url;
    });
</script>
~~~

Если вы делали все верно, то должны увидеть новое изображение на странице каждый раз, когда вы делаете ее перезагрузку!

Если вы потерялись, взгляните на [этот проект в jsbin](http://jsbin.com/canofar/edit?html,output). Именно так должна выглядеть ваша версия. Обратите внимание на стиль кода.

### Задание

1. Прочтите документацию о `fetch` [здесь](https://developer.mozilla.org/ru/docs/Web/API/Fetch_API/Using_Fetch). Интерфейс не сложен в использовании, но на текущий момент мы прошлись по нему лишь поверхностно;
2. Ознакомьтесь со [списком](https://github.com/abhishekbanthia/Public-APIs) бесплатных открытых API. Дайте волю своему воображению!
3. Расширьте и улучшите наш небольшой проект, добавив кнопку, которая загружает новое изображение без обновления страницы;
4. Добавьте окно поиска, чтобы пользователи могли искать определенные картинки. Вам также следует обдумать возможность добавления `.catch()` в конец цепочки обещаний на случай, если Giphy не найдет гифку (gif) с необходимым ключевым словом. Выводите изображение по умолчанию или сообщение об ошибке, если поиск не удался.

## Основы работы с API

### Введение

В последние годы набирает популярность новый подход к разработке сайтов. Вместо того чтобы создавать приложение, в котором находится и база данных, и представление, многие разработчики разбивают его на отдельные проекты, размещая свою базу данных на сервере (либо на Heroku, либо на VPS, таком как Digital Ocean), а затем используя сервис, как github pages или netlify для размещения фронтеда.

Такая организация делает проект более модульным и позволяет использовать один сервер для нескольких типов приложений: веб-сайта, desktop-приложения или мобильного приложения. Многие разработчики используют такой подход, потому что разрабатывают приложение с помощью SPA-фреймворков, таких как React, Vue.

Фронтенд и бэкэнд взаимодействуют друг с другом с помощью JSON, с которым вы уже столкнулись, пройдя курс по JavaScript. На данный момент все, что вам нужно - это заставить ваше express-приложение отдавать JSON вместо HTML, что чрезвычайно просто! В конце этого урока вы поработаете с учебным пособием, но, по сути, все, что вам нужно сделать, это передать вашу информацию в `res.json()` вместо `res.send()` или `res.render()`. Ну как вам?

В express-приложении вы можете настроить роуты так, чтобы часть из них отдавала представления, а часть JSON. Как вы помните, маршруты в нашем проекте ["Библиотека"](https://developer.mozilla.org/ru/docs/Learn/Server-side/Express_Nodejs/routes) располагались в модуле `catalog` и для просмотра списка книг необходимо было получить доступ к `/catalog/books`. Нет ничего сложного в том, чтобы переделать данный проект на работу с JSON. Для этого нужно создать новый модуль под названием `api` и настроить контроллеры таким образом, чтобы `/catalog/books` отображал список наших книг в формате html, а `/api/books` отображал ту же информацию, но в JSON.

### REST

Технически не имеет значения, как вы структурируете свой API. Поскольку вы разрабатываете API для своих собственных приложений и знаете, как получить необходимую информацию или документацию по API, не имеет значения наименование маршрутов. Например, нет разницы между конечной точкой с именем `/api/getAllPostComments/:postid` или с именем `/api/posts/:postid/comments`.
_Тем не менее_, REST (аббревиатура для Representational State Transfer) - это популярный и распространенный подход к разработке API. Следовать такому подходу может быть очень выгодно. Ведь ваш API становится проще и понятней не только для вас, но и для других разработчиков, которые будут работать с ним.

Реальные технические требования REST выглядят немного сложнее (вы можете прочитать о них в [wikipedia](https://ru.wikipedia.org/wiki/REST)). Но для наших целей большинство этих требований (отсутствие состояния, кешируемость и т. д.) покрываются Express с JSON. Важная часть, о которой мы хотим поговорить - это организация наших URI (Uniform Resource Identifier).
REST API завязана на ресурсах. Что это значит? Это значит, что вместо имен типа `/getPostComments` или `/saveNewItemInDatabase` мы обращаемся непосредственно к ресурсу и затем используем глаголы HTTP, чтобы определить, какое действие мы предпринимаем.

Обычно создаются 2 базовых URI на ресурс, один для получения всей коллекции и один для одного объекта этой коллекции. Например, вы можете получить список постов в блоге с помощью `/posts`, а затем получить конкретную запись из `/posts/:postid`. Вы также можете вкладывать коллекции в коллекции. Чтобы получить список комментариев к посту, вы должны обратиться к `/posts/:postid/comments`, а чтобы получить один комментарий: `/posts/:postid/comments/:commentid`.

Как уже упоминалось выше, вы обращаетесь и манипулируете API, используя уже известные вам глаголы HTTP: GET, POST, PUT и DELETE. Значят они в основном то, что вы ожидаете.

- Чтобы получить список сообщений в блоге, вы должны отправить запрос `GET` `/posts`. В результате в вашем express-приложении обработчик `app.get("/posts")` отдаст список всех сообщений;
- Чтобы добавить новое сообщение в блоге, вы должны отправить запрос `POST` в `/posts`;
- Чтобы обновить содержимое поста в блоге, вы должны отправить запрос `PUT` `/posts/:postid`, где `postid` идендтификатор конкретного поста, который вы обновляете;
- Чтобы удалить сообщение, вы должны отправить запрос `DELETE` `/posts/:postid`.

### CORS

[Same Origin Policy (или Политика Одинакового Источника)](https://developer.mozilla.org/ru/docs/Web/Security/Same-origin_policy) является важной концепцией безопасности, которая гласит "Только запросы от одного и того же источника (тот же IP-адрес или URL) должны иметь доступ к этому API" (Изучите по ссылке выше несколько примеров того, что считается "тем же источником"). Это большая проблема для нас сейчас, потому что мы настраиваем наш API таким образом, чтобы получить к нему доступ из разных источников. Поэтому, чтобы получить доступ к API, нам нужно настроить общий доступ к ресурсам (cross-origin resource sharing), или CORS.

Настроить CORS в express очень просто, есть middleware, который все делает за нас. [Эта статья](https://medium.com/@alexishevia/using-cors-in-express-cac7e29b005b) объясняет все, что вам нужно сделать, а официальную документацию можно найти [тут](https://expressjs.com/en/resources/middleware/cors.html).

На данный момент достаточно просто разрешить доступ из любого источника... это немного упрощает разработку, но для _реального_ проекта, после развертывания в боевой среде, вам стоит заблокировать доступ из любого источника _кроме_ вашего фронтенда. В документации выше объясняется, как это сделать.

### Задание

1. [Эта статья] (https://medium.com/@shubhangirajagrawal/the-7-restful-routes-a8e84201f206) является хорошим ресурсом для организации API-интерфейсов RESTful. Две анлогичных статьи на русском: [первая](https://habr.com/ru/post/447322/), [вторая](https://habr.com/ru/post/351890/);
2. Настройте свой REST вместе с [этим учебником](https://www.robinwieruch.de/node-express-server-rest-api/). Это одно из лучших учебных пособий по Express, с которыми мы сталкивались, в нем также рассказывается о модульной организации кода, написании middleware и присутствуют куча ссылок на отличную дополнительную информацию.

## Веб-сервер

Давайте закончим разработкой веб-сервера на Go.
Google предоставлен сервис по адресу [http://chart.apis.google.com](http://chart.apis.google.com) с автоматическим форматированием данных графиков и диаграмм.
Это трудно использовать в интерактивном режиме, но Вам необходимо добавить URL в качестве запроса.
Здесь программа использует приятный простой интерфейс с одной формой для данных: для небольшого кусочка текста, который вызывает сервер диаграмм для создания QR кода, кодируя текст в матрицу пиксел.
Эта картинка можно быть сфотографирована с помощью камеры телефона и интерпретирована, к примеру, как URL, экономя тем самым его набор на маленькой клавиатуре телефона.

Вот программа полностью с последующими пояснениями.

```go
//{{code "/doc/progs/eff_qr.go" `/package/` `$`}}
// Copyright 2009 The Go Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.

package main

import (
	"flag"
	"html/template"
	"log"
	"net/http"
)

var addr = flag.String("addr", ":1718", "http service address") // Q=17, R=18

var templ = template.Must(template.New("qr").Parse(templateStr))

func main() {
	flag.Parse()
	http.Handle("/", http.HandlerFunc(QR))
	err := http.ListenAndServe(*addr, nil)
	if err != nil {
		log.Fatal("ListenAndServe:", err)
	}
}

func QR(w http.ResponseWriter, req *http.Request) {
	templ.Execute(w, req.FormValue("s"))
}

const templateStr = `
<html>
<head>
<title>QR Link Generator</title>
</head>
<body>
{{if .}}
<img src="http://chart.apis.google.com/chart?chs=300x300&cht=qr&choe=UTF-8&chl={{.}}" />
<br>
{{.}}
<br>
<br>
{{end}}
<form action="/" name=f method="GET"><input maxLength=1024 size=70
name=s value="" title="Text to QR Encode"><input type=submit
value="Show QR" name=qr>
</form>
</body>
</html>`
```

Легко понять, что происходит в `main`.
Один флаг устанавливает HTTP сервер по умолчания для нашего сервера.
В значении шаблона `templ`, происходит самое интересное. Он конструирует шаблон HTML, который будет выполнен сервером для показа страницы. Давайте опишем, что происходит в этот момент.

Функция `main` разбирает флаги и использует механизм о котором мы говорили выше, связывает функцию `QR` для корневого пути для сервера.
Когда вызывается `http.ListenAndServe` для старта сервера, он блокируется пока сервер запущен.

Функция `QR` только получает запрос, который содержит дынные формы, и выполняет шаблон на данных в форме с именем переменной `s`.


Пакет шаблонов `html/template` мощный; данная программа лишь слегка затрагивает его возможности.
По сути, он переписывает часть текста HTML на лету, заменяя элементы на элементы данных, передаваемые в `templ.Execute`, в данном случаи переменной формы.
В тексте шаблона (`templateStr`), имеются *двойные скобки разделители* обозначающие действия шаблона.
Участок от `{{html "{{if .}}"}}` до `{{html "{{end}}"}}` выполняются только если значения текущей элемента данных, вызывают `.` (точка) не пустая. То есть, если строка пуста, то данный участок шаблона игнорируется.


Два примере кода `{{html "{{.}}"}}` предназначены для показа существующих данных в запросе шаблона на веб странице.
Пакет шаблонов HTML автоматически обеспечивает соответствие, поэтому текст является безопасным для отображения.


Остальные строки шаблона, просто строки HTML , которые показываются при загрузки страницы.
Если это слишком быстрое объяснение, то смотрите [документацию](https://golang.org/pkg/html/template/) о пакете шаблонов для большего понимания.

В результате у Вас есть: полезный пример веб сервера из нескольких строк кода с управлением данных текста HTML.
Язык Go достаточно мощный для создание много чего интересного за несколько строк.

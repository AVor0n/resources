## Тестируем работу с базой данных

Когда код, который вы тестируете, связан с базой данных, количество настроек, которые вам нужно сделать, становится немного больше. Очевидно, что вы не хотите запускать тесты в production базе данных из-за риска компрометации данных вашего пользователя. В этом уроке мы запустим новую версию нашей базы данных mongo в памяти, а затем скажем нашему приложению использовать ее во время тестов.

### Но нужно ли все это нам?

Перед углублением вы можете подумать, нужно ли вообще тестировать работу с базой данных. Если вы просто читаете и пишете прямо в базе данных, используя `mongoose` или какой-либо другой модуль БД, вам могут не потребоваться тесты. Mongoose (и все другие популярные модули БД) уже имеет [множество тестов](https://github.com/Automattic/mongoose/tree/master/test) для всех операций. Если вы просто передаете JSON API в эти операции, то возможно тестирование не имеет смысла.

Но, если ваши запросы сложны или используют ваш собственный код для фильтрации, сортировки, манипуляции с данными, то использование тестов оправдано. В случае вашего собственного кода будет лучше, если вы извлечете его в отдельный от операций с вашей базой данных модуль. В результате, вы сможете протестировать ваш код без возни с базой данных.

### mongodb-memory-server

Однако есть случаи, когда вы захотите проверить что-то, касающееся вашей production базы данных. Мы расскажем как это сделать!

Мы воспользуемся пакетом npm под названием `mongodb-memory-server`. Вы можете увидеть подробности в их [репозитории](https://github.com/nodkz/mongodb-memory-server). Этот пакет поднимет новый сервер mongoDB в памяти, к которому можно подключиться с помощью mongoose , а затем использовать в тестах. Поскольку `mongodb-memory-server` создает новую БД каждый раз, вам не нужно беспокоиться о попытке синхронизировать данные или загрязнять production базу данных.

Настройка проста, но есть несколько вещей, которые вам нужно сделать. Во-первых, в вашем реальном приложении нужно переместить настройки mongo / mongoose в отдельный файл, как показано в примере ниже:

~~~javascript
//// mongoConfig.js
const mongoose = require("mongoose");
const Schema = mongoose.Schema;

const mongoDb = "ВАШ URL ДО MONGO";

mongoose.connect(mongoDb, { useNewUrlParser: true });
const db = mongoose.connection;
db.on("error", console.error.bind(console, "ошибка подключения к mongo"));
~~~

Приведенный код должен быть вам знаком... это тот самый код установки, который мы использовали все это время. Единственное отличие состоит в том, что мы переместили его в отдельный файл и, в результате, в тестах мы можем использовать _другой_ файл конфигурации, который задает для нас `mongodb-memory-server`. Все, что вам нужно сделать, подключить mongoConfig с помощью строчки `require("./mongoConfig")` в `app.js`.

Далее нам нужно создать отдельный конфиг для нашего тестового окружения. Конфигурационный файл, который вы можете найти в репозитории README `mongodb-memory-server`, должен отлично подойти. Ниже приведена слегка отредактированная версия. Скопируйте это в новый файл с именем `mongoConfigTesting.js`.

~~~javascript
//// mongoConfigTesting.js 
const mongoose = require("mongoose");
const { MongoMemoryServer } = require("mongodb-memory-server");

const mongoServer = new MongoMemoryServer();

mongoose.Promise = Promise;
mongoServer.getConnectionString().then(mongoUri => {
  const mongooseOpts = {
    // настройки дл mongoose 4.11.3 и ниже
    autoReconnect: true,
    reconnectTries: Number.MAX_VALUE,
    reconnectInterval: 1000,
    useNewUrlParser: true
  };

  mongoose.connect(mongoUri, mongooseOpts);

  mongoose.connection.on("error", e => {
    if (e.message.code === "ETIMEDOUT") {
      console.log(e);
      mongoose.connect(mongoUri, mongooseOpts);
    }
    console.log(e);
  });

  mongoose.connection.once("open", () => {
    console.log(`MongoDB успешно подключилось по ${mongoUri}`);
  });
});
~~~

Теперь, если ваши тесты настроены аналогично тестам последнего проекта, вы можете импортировать этот файл в верхней части вашего теста. Тогда тесты, которые работают с базой данных mongo, будут использовать тестовую базу данных вместо боевой (production).

### Пара заметок

Поскольку вы начинаете свои тесты с пустой базы данных, вам будет полезно использовать функцию `beforeAll`. `beforeAll` поможет добавить пару элементов в базу данных перед запуском тестов.

Это не единственный способ настроить тестовое окружение! Если вы используете `nconf`, аргументы командной строки или что-то еще для настройки development и production среды, вы можете легко добавить тестовую среду, которая использует `mongodb-memory-server`. [Документация Jest](https://jestjs.io/docs/en/mongodb) демонстрирует альтернативную (но похожую) настройку. Общим является то, что независимо от того, как мы это сделаем, наша цель - использовать альтернативную БД при выполнении тестов.
